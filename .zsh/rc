# vim: filetype=zsh
# Florian Wallners zshrc

if [ -d ${HOME}/bin ]; then
    PATH=${HOME}/bin:$PATH
fi

if [ -d "${HOME}/.local/bin" ]; then
    PATH=${HOME}/.local/bin:${PATH}
fi


export HISTSIZE=6144
export SAVEHIST=4096
export HISTFILE=$HOME/.zsh/history

# keybindgs
bindkey -e                  # emacs key bindings
bindkey ' ' magic-space     # also do history expansion on space
bindkey "\e[3~" delete-char # make delete work correctly

# The options. Listed  here are only those that differ from the defaults.
# They are ordered alphabetically not by subject.
setopt ALWAYS_TO_END        # Move to end of word after completion
setopt AUTO_CD              # If an unknown command is a directory cd into it.
setopt BRACE_CCL            # Expand expressions in braces
setopt COMPLETE_IN_WORD     # Don't move to end of word when completeing.
setopt CORRECT              # Try auto correction of commands
setopt EQUALS               # Filename expansion on right hand side of '='
setopt HIST_IGNORE_ALL_DUPS # Remove all duplicates from the history
setopt HIST_NO_STORE        # Don't store history in the history
setopt HIST_REDUCE_BLANKS   # Remove all superflous blanks from history entries
setopt SHARE_HISTORY        # History is shared between shells.
setopt LONG_LIST_JOBS       # Display jobs in long list formats
setopt MARK_DIRS            # Mark a generated filename as directory '/'
setopt NUMERIC_GLOB_SORT    # Sort generated numerical file names numerical
setopt PUSHD_TO_HOME        # empty pushd pushes '~' onto stack

export EDITOR=vim
export PAGER=less
export LESS='-deFgiMRSX -P?fFile %f:stdin. ?m(%i of %m) :.line %l ?Lof %L:.?p (%p\%):.'
export LESSCHARSET=utf-8   # Is this still necessary?
# Format man pages for a wigth of 80 col no matter how wide the terminal
export MANWIDTH=80
# Use bat as manual pager
export MANPAGER="sh -c 'col -bx | bat -l man -p'"
export MANROFFOPT="-c"

# In the process of switching to bat, but for the time beiing...
if [ -f /usr/share/source-highlight/src-hilite-lesspipe.sh ]; then
    LESSOPEN="| /usr/bin/src-hilite-lesspipe.sh %s"
fi

export BAT_THEME="Solarized (dark)"

# Don't ignore leading dots when sorting.
export LC_COLLATE="C"
export LC_CTYPE=en_US.UTF-8
export LANG=en_US.UTF-8

# Set up aliases
alias mv='nocorrect mv'    # no spelling correction on mv
alias cp='nocorrect cp'    # no spelling correction on cp
alias mkdir='nocorrect mkdir' # no spelling correction on mkdir
alias ll='ls -l'
alias la='ls -a'
alias cd..="cd .."
alias \#='sudo'
alias doch='sudo $(fc -ln -1)'
alias cat='bat -p'
alias xps='ps aucx | head -1; ps aucx | grep -i '
alias https='http --default-scheme=https'
alias xc='xclip -i -selection clipboard'

# Completition control

if [ -d "${HOME}/.zsh/completion" ]; then
    fpath=(${HOME}/.zsh/completion/ $fpath)
fi

autoload -Uz compinit && compinit -i
autoload -U +X bashcompinit && bashcompinit

# initialize antidote
source ${HOME}/.zsh/antidote/antidote.zsh
bundlefile=${HOME}/.zsh/plugins.txt
zstyle ':antidote:bundle' file $bundlefile
staticfile=${HOME}/.zsh/plugins.zsh
zstyle ':antidote:static' file $staticfile
antidote load

# Completion caching
zstyle ':completion::complete:*' use-cache 1
zstyle ':completion::complete:*' cache-path $HOME/.zsh/cache/$HOST

# formatting and messages
zstyle ':completion:*' verbose yes
zstyle ':completion:*:descriptions' format '[%d]'
zstyle ':completion:*:messages' format '%d'
zstyle ':completion:*:warnings' format 'No matches for: %d'
zstyle ':completion:*:corrections' format '%B%d (errors: %e)%b'
zstyle ':completion:*' group-name ''

# match uppercase from lowercase
zstyle ':completion:*' matcher-list 'm:{a-z}={A-Z}'

# activate menu selection
zstyle ':completion:*' menu select

# offer indexes before parameters in subscripts
zstyle ':completion:*:*:-subscript-:*' tag-order indexes parameters

# Don't complete backup files as executables
zstyle ':completion:*:complete:-command-::commands' ignored-patterns '*\~'

# Separate matches into groups
zstyle ':completion:*:matches' group 'yes'

# Describe options in full
zstyle ':completion:*:options' description 'yes'
zstyle ':completion:*:options' auto-description '%d'

# enable fzf
export FZF_DEFAULT_OPTS="--height 40% --layout=reverse-list --no-separator"
export FZF_DEFAULT_COMMAND='fd --type f --hidden --ignore-file "$HOME/.gitexcludes" \
                               --exclude .git --strip-cwd-prefix'
export FZF_CTRL_T_COMMAND=${FZF_DEFAULT_COMMAND}
export FZF_CTRL_T_OPTS="${FZF_DEFAULT_OPTS} --preview 'bat --style=numbers --color=always {} | head -500'"
export FZF_COMPLETION_OPTS='--border --info=inline'

source /usr/share/fzf/shell/key-bindings.zsh
# this is a bug in the fedora shipped fzf RPM
source /usr/share/zsh/site-functions/fzf

zstyle ':fzf-tab:*' default-color $'\033[38;5;245m'
zstyle ':fzf-tab:complete:cd:*' fzf-preview 'exa -1 --color=always $realpath'

if [ $(which terraform > /dev/null 2>&1) ]; then
    complete -o nospace -C /usr/bin/terraform terraform
fi

if [ $(which kubectl > /dev/null 2>&1) ]; then
    source <(kubectl completion zsh)
fi

if [ $(which minikube > /dev/null 2>&1) ]; then
    source <(minikube completion zsh)
fi

if [ $(which helm > /dev/null 2>&1) ]; then
    source <(helm completion zsh)
fi

if [ $(which k3d > /dev/null 2>&1) ]; then
    source <(k3d completion zsh)
fi

if [ $(which stern > /dev/null 2>&1) ]; then
    source <(stern --completion zsh)
fi

if [ -f /usr/lib64/google-cloud-sdk/completion.zsh.inc ]; then
    source "/usr/lib64/google-cloud-sdk/completion.zsh.inc"
fi

if [ -f $HOME/.ocd.sh ]; then
    source "$HOME/.ocd.sh"
fi

eval "$(direnv hook zsh)"

# Removing duplicate entries from $PATH
typeset -U PATH

